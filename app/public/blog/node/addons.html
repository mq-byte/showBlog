<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>C++ Addons | QLQ学习平台</title>
    <meta name="description" content="QLQ学习平台">
    <link rel="manifest" href="/public/blog/manifest.json">
    
    <link rel="preload" href="/public/blog/assets/css/0.styles.3ad33863.css" as="style"><link rel="preload" href="/public/blog/assets/js/app.793d18d6.js" as="script"><link rel="preload" href="/public/blog/assets/js/2.d1dd4e4d.js" as="script"><link rel="preload" href="/public/blog/assets/js/10.7d4b1d4b.js" as="script"><link rel="preload" href="/public/blog/assets/js/3.1f730cd9.js" as="script"><link rel="prefetch" href="/public/blog/assets/js/11.c135c766.js"><link rel="prefetch" href="/public/blog/assets/js/12.17db24c5.js"><link rel="prefetch" href="/public/blog/assets/js/13.6e07cbcf.js"><link rel="prefetch" href="/public/blog/assets/js/14.ea2a0d07.js"><link rel="prefetch" href="/public/blog/assets/js/15.a6a7563b.js"><link rel="prefetch" href="/public/blog/assets/js/16.956a9122.js"><link rel="prefetch" href="/public/blog/assets/js/17.06ff4bf4.js"><link rel="prefetch" href="/public/blog/assets/js/18.a604e43f.js"><link rel="prefetch" href="/public/blog/assets/js/19.43fdc1b1.js"><link rel="prefetch" href="/public/blog/assets/js/20.faad6d2d.js"><link rel="prefetch" href="/public/blog/assets/js/21.554b2f54.js"><link rel="prefetch" href="/public/blog/assets/js/22.961d3c7f.js"><link rel="prefetch" href="/public/blog/assets/js/23.98032a48.js"><link rel="prefetch" href="/public/blog/assets/js/24.735ada0c.js"><link rel="prefetch" href="/public/blog/assets/js/25.151f485c.js"><link rel="prefetch" href="/public/blog/assets/js/26.f3d12769.js"><link rel="prefetch" href="/public/blog/assets/js/27.d91bf872.js"><link rel="prefetch" href="/public/blog/assets/js/28.2a36a68f.js"><link rel="prefetch" href="/public/blog/assets/js/29.78b1b45d.js"><link rel="prefetch" href="/public/blog/assets/js/30.7481d4c5.js"><link rel="prefetch" href="/public/blog/assets/js/31.16e7c775.js"><link rel="prefetch" href="/public/blog/assets/js/32.75fed837.js"><link rel="prefetch" href="/public/blog/assets/js/33.cf2e0b8f.js"><link rel="prefetch" href="/public/blog/assets/js/34.4221897d.js"><link rel="prefetch" href="/public/blog/assets/js/35.97e4fc88.js"><link rel="prefetch" href="/public/blog/assets/js/36.137598cd.js"><link rel="prefetch" href="/public/blog/assets/js/37.9b12e9de.js"><link rel="prefetch" href="/public/blog/assets/js/38.8d385bd4.js"><link rel="prefetch" href="/public/blog/assets/js/39.c2d2376a.js"><link rel="prefetch" href="/public/blog/assets/js/4.a6ed393e.js"><link rel="prefetch" href="/public/blog/assets/js/40.a2197e85.js"><link rel="prefetch" href="/public/blog/assets/js/41.6e6eb90b.js"><link rel="prefetch" href="/public/blog/assets/js/42.ba8fc1fa.js"><link rel="prefetch" href="/public/blog/assets/js/43.561011ab.js"><link rel="prefetch" href="/public/blog/assets/js/44.0e624559.js"><link rel="prefetch" href="/public/blog/assets/js/45.31eb2ed7.js"><link rel="prefetch" href="/public/blog/assets/js/46.33d8378f.js"><link rel="prefetch" href="/public/blog/assets/js/47.18b18711.js"><link rel="prefetch" href="/public/blog/assets/js/48.84db573a.js"><link rel="prefetch" href="/public/blog/assets/js/49.e007afae.js"><link rel="prefetch" href="/public/blog/assets/js/5.868620b4.js"><link rel="prefetch" href="/public/blog/assets/js/50.05e06075.js"><link rel="prefetch" href="/public/blog/assets/js/51.28689d1c.js"><link rel="prefetch" href="/public/blog/assets/js/52.84b0ef5c.js"><link rel="prefetch" href="/public/blog/assets/js/53.693b991f.js"><link rel="prefetch" href="/public/blog/assets/js/54.3ebbd2e5.js"><link rel="prefetch" href="/public/blog/assets/js/55.c466c411.js"><link rel="prefetch" href="/public/blog/assets/js/56.02fb13e9.js"><link rel="prefetch" href="/public/blog/assets/js/57.a0811a6e.js"><link rel="prefetch" href="/public/blog/assets/js/58.ef3c4301.js"><link rel="prefetch" href="/public/blog/assets/js/59.5ecba546.js"><link rel="prefetch" href="/public/blog/assets/js/6.8e0ec0a1.js"><link rel="prefetch" href="/public/blog/assets/js/60.41e35580.js"><link rel="prefetch" href="/public/blog/assets/js/61.51154b06.js"><link rel="prefetch" href="/public/blog/assets/js/62.e557785e.js"><link rel="prefetch" href="/public/blog/assets/js/63.6ee35392.js"><link rel="prefetch" href="/public/blog/assets/js/64.5bb83569.js"><link rel="prefetch" href="/public/blog/assets/js/65.b26f077a.js"><link rel="prefetch" href="/public/blog/assets/js/7.287519a5.js"><link rel="prefetch" href="/public/blog/assets/js/8.ad4df861.js"><link rel="prefetch" href="/public/blog/assets/js/9.ef0461e8.js">
    <link rel="stylesheet" href="/public/blog/assets/css/0.styles.3ad33863.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/public/blog/" class="home-link router-link-active"><!----> <span class="site-name">QLQ学习平台</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/public/blog/js/regexp.html" class="nav-link">javaScript</a></div><div class="nav-item"><a href="/public/blog/css/bfc.html" class="nav-link">css</a></div><div class="nav-item"><a href="/public/blog/webpack/base-config.html" class="nav-link">webpack</a></div><div class="nav-item"><a href="/public/blog/node/nodemon.html" class="nav-link">node</a></div><div class="nav-item"><a href="/public/blog/fragment/angular.html" class="nav-link">js框架</a></div><div class="nav-item"><a href="/public/blog/pwa/PWA.html" class="nav-link">pwa</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/public/blog/js/regexp.html" class="nav-link">javaScript</a></div><div class="nav-item"><a href="/public/blog/css/bfc.html" class="nav-link">css</a></div><div class="nav-item"><a href="/public/blog/webpack/base-config.html" class="nav-link">webpack</a></div><div class="nav-item"><a href="/public/blog/node/nodemon.html" class="nav-link">node</a></div><div class="nav-item"><a href="/public/blog/fragment/angular.html" class="nav-link">js框架</a></div><div class="nav-item"><a href="/public/blog/pwa/PWA.html" class="nav-link">pwa</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>node</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/public/blog/node/buffer.html" class="sidebar-link">Buffer</a></li><li><a href="/public/blog/node/stream.html" class="sidebar-link">Stream</a></li><li><a href="/public/blog/node/nodemon.html" class="sidebar-link">nodemon：高效的nodejs开发环境</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="c-addons"><a href="#c-addons" class="header-anchor">#</a> C++ Addons</h1> <p>Node.js Addons are dynamically-linked shared objects, written in C++, that
can be loaded into Node.js using the <a href="/public/blog/node/modules.html#modules_require_id"><code>require()</code></a> function, and used
just as if they were an ordinary Node.js module. They are used primarily to
provide an interface between JavaScript running in Node.js and C/C++ libraries.</p> <p>There are three options for implementing Addons: N-API, nan, or direct
use of internal V8, libuv and Node.js libraries. Unless you need direct
access to functionality which is not exposed by N-API, use N-API.
Refer to <a href="/public/blog/node/n-api.html">C/C++ Addons with N-API</a> for more information on N-API.</p> <p>When not using N-API, implementing Addons is complicated,
involving knowledge of several components and APIs:</p> <ul><li><p>V8: the C++ library Node.js currently uses to provide the
JavaScript implementation. V8 provides the mechanisms for creating objects,
calling functions, etc. V8's API is documented mostly in the
<code>v8.h</code> header file (<code>deps/v8/include/v8.h</code> in the Node.js source
tree), which is also available <a href="https://v8docs.nodesource.com/" target="_blank" rel="noopener noreferrer">online<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p></li> <li><p><a href="https://github.com/libuv/libuv" target="_blank" rel="noopener noreferrer">libuv<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>: The C library that implements the Node.js event loop, its worker
threads and all of the asynchronous behaviors of the platform. It also
serves as a cross-platform abstraction library, giving easy, POSIX-like
access across all major operating systems to many common system tasks, such
as interacting with the filesystem, sockets, timers, and system events. libuv
also provides a pthreads-like threading abstraction that may be used to
power more sophisticated asynchronous Addons that need to move beyond the
standard event loop. Addon authors are encouraged to think about how to
avoid blocking the event loop with I/O or other time-intensive tasks by
off-loading work via libuv to non-blocking system operations, worker threads
or a custom use of libuv's threads.</p></li> <li><p>Internal Node.js libraries. Node.js itself exports C++ APIs that Addons can
use, the most important of which is the <code>node::ObjectWrap</code> class.</p></li> <li><p>Node.js includes other statically linked libraries including OpenSSL. These
other libraries are located in the <code>deps/</code> directory in the Node.js source
tree. Only the libuv, OpenSSL, V8 and zlib symbols are purposefully
re-exported by Node.js and may be used to various extents by Addons. See
<a href="#addons_linking_to_node_js_own_dependencies">Linking to Node.js' own dependencies</a> for additional information.</p></li></ul> <p>All of the following examples are available for <a href="https://github.com/nodejs/node-addon-examples" target="_blank" rel="noopener noreferrer">download<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and may
be used as the starting-point for an Addon.</p> <h2 id="hello-world"><a href="#hello-world" class="header-anchor">#</a> Hello world</h2> <p>This &quot;Hello world&quot; example is a simple Addon, written in C++, that is the
equivalent of the following JavaScript code:</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">hello</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'world'</span><span class="token punctuation">;</span>
</code></pre></div><p>First, create the file <code>hello.cc</code>:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// hello.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h&gt;</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>NewStringType<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>String<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Value<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">Method</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>
      isolate<span class="token punctuation">,</span> <span class="token string">&quot;world&quot;</span><span class="token punctuation">,</span> NewStringType<span class="token operator">::</span>kNormal<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Initialize</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">NODE_SET_METHOD</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> Method<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> Initialize<span class="token punctuation">)</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace demo</span>
</code></pre></div><p>All Node.js Addons must export an initialization function following
the pattern:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">Initialize</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">NODE_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> Initialize<span class="token punctuation">)</span>
</code></pre></div><p>There is no semi-colon after <code>NODE_MODULE</code> as it's not a function (see
<code>node.h</code>).</p> <p>The <code>module_name</code> must match the filename of the final binary (excluding
the <code>.node</code> suffix).</p> <p>In the <code>hello.cc</code> example, then, the initialization function is <code>Initialize</code>
and the addon module name is <code>addon</code>.</p> <p>When building addons with <code>node-gyp</code>, using the macro <code>NODE_GYP_MODULE_NAME</code> as
the first parameter of <code>NODE_MODULE()</code> will ensure that the name of the final
binary will be passed to <code>NODE_MODULE()</code>.</p> <h3 id="context-aware-addons"><a href="#context-aware-addons" class="header-anchor">#</a> Context-aware addons</h3> <p>There are environments in which Node.js addons may need to be loaded multiple
times in multiple contexts. For example, the <a href="https://electronjs.org/" target="_blank" rel="noopener noreferrer">Electron<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> runtime runs multiple
instances of Node.js in a single process. Each instance will have its own
<code>require()</code> cache, and thus each instance will need a native addon to behave
correctly when loaded via <code>require()</code>. From the addon's perspective, this means
that it must support multiple initializations.</p> <p>A context-aware addon can be constructed by using the macro
<code>NODE_MODULE_INITIALIZER</code>, which expands to the name of a function which Node.js
will expect to find when it loads an addon. An addon can thus be initialized as
in the following example:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">using</span> <span class="token keyword">namespace</span> v8<span class="token punctuation">;</span>

<span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> NODE_MODULE_EXPORT <span class="token keyword">void</span>
<span class="token function">NODE_MODULE_INITIALIZER</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">,</span>
                        Local<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> module<span class="token punctuation">,</span>
                        Local<span class="token operator">&lt;</span>Context<span class="token operator">&gt;</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* Perform addon initialization steps here. */</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Another option is to use the macro <code>NODE_MODULE_INIT()</code>, which will also
construct a context-aware addon. Unlike <code>NODE_MODULE()</code>, which is used to
construct an addon around a given addon initializer function,
<code>NODE_MODULE_INIT()</code> serves as the declaration of such an initializer to be
followed by a function body.</p> <p>The following three variables may be used inside the function body following an
invocation of <code>NODE_MODULE_INIT()</code>:</p> <ul><li><code>Local&lt;Object&gt; exports</code>,</li> <li><code>Local&lt;Value&gt; module</code>, and</li> <li><code>Local&lt;Context&gt; context</code></li></ul> <p>The choice to build a context-aware addon carries with it the responsibility of
carefully managing global static data. Since the addon may be loaded multiple
times, potentially even from different threads, any global static data stored
in the addon must be properly protected, and must not contain any persistent
references to JavaScript objects. The reason for this is that JavaScript
objects are only valid in one context, and will likely cause a crash when
accessed from the wrong context or from a different thread than the one on which
they were created.</p> <p>The context-aware addon can be structured to avoid global static data by
performing the following steps:</p> <ul><li>defining a class which will hold per-addon-instance data. Such
a class should include a <code>v8::Persistent&lt;v8::Object&gt;</code> which will hold a weak
reference to the addon's <code>exports</code> object. The callback associated with the weak
reference will then destroy the instance of the class.</li> <li>constructing an instance of this class in the addon initializer such that the
<code>v8::Persistent&lt;v8::Object&gt;</code> is set to the <code>exports</code> object.</li> <li>storing the instance of the class in a <code>v8::External</code>, and</li> <li>passing the <code>v8::External</code> to all methods exposed to JavaScript by passing it
to the <code>v8::FunctionTemplate</code> constructor which creates the native-backed
JavaScript functions. The <code>v8::FunctionTemplate</code> constructor's third parameter
accepts the <code>v8::External</code>.</li></ul> <p>This will ensure that the per-addon-instance data reaches each binding that can
be called from JavaScript. The per-addon-instance data must also be passed into
any asynchronous callbacks the addon may create.</p> <p>The following example illustrates the implementation of a context-aware addon:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> v8<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">AddonData</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">AddonData</span><span class="token punctuation">(</span>Isolate<span class="token operator">*</span> isolate<span class="token punctuation">,</span> Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">)</span><span class="token operator">:</span>
      <span class="token function">call_count</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Link the existence of this object instance to the existence of exports.</span>
    exports_<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> exports<span class="token punctuation">)</span><span class="token punctuation">;</span>
    exports_<span class="token punctuation">.</span><span class="token function">SetWeak</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> DeleteMe<span class="token punctuation">,</span> WeakCallbackType<span class="token operator">::</span>kParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token operator">~</span><span class="token function">AddonData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exports_<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Reset the reference to avoid leaking data.</span>
      exports_<span class="token punctuation">.</span><span class="token function">ClearWeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      exports_<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Per-addon data.</span>
  <span class="token keyword">int</span> call_count<span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token comment">// Method to call when &quot;exports&quot; is about to be garbage-collected.</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">DeleteMe</span><span class="token punctuation">(</span><span class="token keyword">const</span> WeakCallbackInfo<span class="token operator">&lt;</span>AddonData<span class="token operator">&gt;</span><span class="token operator">&amp;</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> info<span class="token punctuation">.</span><span class="token function">GetParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Weak handle to the &quot;exports&quot; object. An instance of this class will be</span>
  <span class="token comment">// destroyed along with the exports object to which it is weakly bound.</span>
  v8<span class="token operator">::</span>Persistent<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Object<span class="token operator">&gt;</span> exports_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Method</span><span class="token punctuation">(</span><span class="token keyword">const</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Retrieve the per-addon-instance data.</span>
  AddonData<span class="token operator">*</span> data <span class="token operator">=</span>
      <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>AddonData<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>As<span class="token operator">&lt;</span>External<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  data<span class="token operator">-&gt;</span>call_count<span class="token operator">++</span><span class="token punctuation">;</span>
  info<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>data<span class="token operator">-&gt;</span>call_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Initialize this addon to be context-aware.</span>
<span class="token function">NODE_MODULE_INIT</span><span class="token punctuation">(</span><span class="token comment">/* exports, module, context */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> context<span class="token operator">-&gt;</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Create a new instance of AddonData for this instance of the addon.</span>
  AddonData<span class="token operator">*</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">AddonData</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> exports<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Wrap the data in a v8::External so we can pass it to the method we expose.</span>
  Local<span class="token operator">&lt;</span>External<span class="token operator">&gt;</span> external <span class="token operator">=</span> External<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Expose the method &quot;Method&quot; to JavaScript, and make sure it receives the</span>
  <span class="token comment">// per-addon-instance data we created above by passing `external` as the</span>
  <span class="token comment">// third parameter to the FunctionTemplate constructor.</span>
  exports<span class="token operator">-&gt;</span><span class="token function">Set</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>
               String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> <span class="token string">&quot;method&quot;</span><span class="token punctuation">,</span> NewStringType<span class="token operator">::</span>kNormal<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               FunctionTemplate<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> Method<span class="token punctuation">,</span> external<span class="token punctuation">)</span>
                  <span class="token operator">-&gt;</span><span class="token function">GetFunction</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FromJust</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="worker-support"><a href="#worker-support" class="header-anchor">#</a> Worker support</h4> <p>In order to be loaded from multiple Node.js environments,
such as a main thread and a Worker thread, an add-on needs to either:</p> <ul><li>Be an N-API addon, or</li> <li>Be declared as context-aware using <code>NODE_MODULE_INIT()</code> as described above</li></ul> <p>In order to support <a href="/public/blog/node/worker_threads.html#worker_threads_class_worker"><code>Worker</code></a> threads, addons need to clean up any resources
they may have allocated when such a thread exists. This can be achieved through
the usage of the <code>AddEnvironmentCleanupHook()</code> function:</p> <div class="language-c++ extra-class"><pre class="language-text"><code>void AddEnvironmentCleanupHook(v8::Isolate* isolate,
                               void (*fun)(void* arg),
                               void* arg);
</code></pre></div><p>This function adds a hook that will run before a given Node.js instance shuts
down. If necessary, such hooks can be removed using
<code>RemoveEnvironmentCleanupHook()</code> before they are run, which has the same
signature. Callbacks are run in last-in first-out order.</p> <p>The following <code>addon.cc</code> uses <code>AddEnvironmentCleanupHook</code>:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// addon.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h&gt;</span></span>

<span class="token keyword">using</span> node<span class="token operator">::</span>AddEnvironmentCleanupHook<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>HandleScope<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>

<span class="token comment">// Note: In a real-world application, do not rely on static/global data.</span>
<span class="token keyword">static</span> <span class="token keyword">char</span> cookie<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;yum yum&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> cleanup_cb1_called <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> cleanup_cb2_called <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cleanup_cb1</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>Isolate<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  HandleScope <span class="token function">scope</span><span class="token punctuation">(</span>isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> obj <span class="token operator">=</span> Object<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// assert VM is still alive</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>obj<span class="token operator">-&gt;</span><span class="token function">IsObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cleanup_cb1_called<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cleanup_cb2</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>arg <span class="token operator">==</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cleanup_cb2_called<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sanity_check</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>cleanup_cb1_called <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>cleanup_cb2_called <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Initialize this addon to be context-aware.</span>
<span class="token function">NODE_MODULE_INIT</span><span class="token punctuation">(</span><span class="token comment">/* exports, module, context */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> context<span class="token operator">-&gt;</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">AddEnvironmentCleanupHook</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> sanity_check<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AddEnvironmentCleanupHook</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> cleanup_cb2<span class="token punctuation">,</span> cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AddEnvironmentCleanupHook</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> cleanup_cb1<span class="token punctuation">,</span> isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Test in JavaScript by running:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// test.js</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="building"><a href="#building" class="header-anchor">#</a> Building</h3> <p>Once the source code has been written, it must be compiled into the binary
<code>addon.node</code> file. To do so, create a file called <code>binding.gyp</code> in the
top-level of the project describing the build configuration of the module
using a JSON-like format. This file is used by <a href="https://github.com/nodejs/node-gyp" target="_blank" rel="noopener noreferrer">node-gyp<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> — a tool written
specifically to compile Node.js Addons.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;targets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;target_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;addon&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;sources&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;hello.cc&quot;</span> <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>A version of the <code>node-gyp</code> utility is bundled and distributed with
Node.js as part of <code>npm</code>. This version is not made directly available for
developers to use and is intended only to support the ability to use the
<code>npm install</code> command to compile and install Addons. Developers who wish to
use <code>node-gyp</code> directly can install it using the command
<code>npm install -g node-gyp</code>. See the <code>node-gyp</code> <a href="https://github.com/nodejs/node-gyp#installation" target="_blank" rel="noopener noreferrer">installation instructions<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for
more information, including platform-specific requirements.</p> <p>Once the <code>binding.gyp</code> file has been created, use <code>node-gyp configure</code> to
generate the appropriate project build files for the current platform. This
will generate either a <code>Makefile</code> (on Unix platforms) or a <code>vcxproj</code> file
(on Windows) in the <code>build/</code> directory.</p> <p>Next, invoke the <code>node-gyp build</code> command to generate the compiled <code>addon.node</code>
file. This will be put into the <code>build/Release/</code> directory.</p> <p>When using <code>npm install</code> to install a Node.js Addon, npm uses its own bundled
version of <code>node-gyp</code> to perform this same set of actions, generating a
compiled version of the Addon for the user's platform on demand.</p> <p>Once built, the binary Addon can be used from within Node.js by pointing
<a href="/public/blog/node/modules.html#modules_require_id"><code>require()</code></a> to the built <code>addon.node</code> module:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// hello.js</span>
<span class="token keyword">const</span> addon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>addon<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Prints: 'world'</span>
</code></pre></div><p>Because the exact path to the compiled Addon binary can vary depending on how
it is compiled (i.e. sometimes it may be in <code>./build/Debug/</code>), Addons can use
the <a href="https://github.com/TooTallNate/node-bindings" target="_blank" rel="noopener noreferrer">bindings<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> package to load the compiled module.</p> <p>While the <code>bindings</code> package implementation is more sophisticated in how it
locates Addon modules, it is essentially using a <code>try…catch</code> pattern similar to:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Release/addon.node'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Debug/addon.node'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="linking-to-node-js-own-dependencies"><a href="#linking-to-node-js-own-dependencies" class="header-anchor">#</a> Linking to Node.js' own dependencies</h3> <p>Node.js uses statically linked libraries such as V8, libuv and OpenSSL. All
Addons are required to link to V8 and may link to any of the other dependencies
as well. Typically, this is as simple as including the appropriate
<code>#include &lt;...&gt;</code> statements (e.g. <code>#include &lt;v8.h&gt;</code>) and <code>node-gyp</code> will locate
the appropriate headers automatically. However, there are a few caveats to be
aware of:</p> <ul><li><p>When <code>node-gyp</code> runs, it will detect the specific release version of Node.js
and download either the full source tarball or just the headers. If the full
source is downloaded, Addons will have complete access to the full set of
Node.js dependencies. However, if only the Node.js headers are downloaded, then
only the symbols exported by Node.js will be available.</p></li> <li><p><code>node-gyp</code> can be run using the <code>--nodedir</code> flag pointing at a local Node.js
source image. Using this option, the Addon will have access to the full set of
dependencies.</p></li></ul> <h3 id="loading-addons-using-require"><a href="#loading-addons-using-require" class="header-anchor">#</a> Loading Addons using require()</h3> <p>The filename extension of the compiled Addon binary is <code>.node</code> (as opposed
to <code>.dll</code> or <code>.so</code>). The <a href="/public/blog/node/modules.html#modules_require_id"><code>require()</code></a> function is written to look for
files with the <code>.node</code> file extension and initialize those as dynamically-linked
libraries.</p> <p>When calling <a href="/public/blog/node/modules.html#modules_require_id"><code>require()</code></a>, the <code>.node</code> extension can usually be
omitted and Node.js will still find and initialize the Addon. One caveat,
however, is that Node.js will first attempt to locate and load modules or
JavaScript files that happen to share the same base name. For instance, if
there is a file <code>addon.js</code> in the same directory as the binary <code>addon.node</code>,
then <a href="/public/blog/node/modules.html#modules_require_id"><code>require('addon')</code></a> will give precedence to the <code>addon.js</code> file
and load it instead.</p> <h2 id="native-abstractions-for-node-js"><a href="#native-abstractions-for-node-js" class="header-anchor">#</a> Native Abstractions for Node.js</h2> <p>Each of the examples illustrated in this document make direct use of the
Node.js and V8 APIs for implementing Addons. The V8 API can, and has, changed
dramatically from one V8 release to the next (and one major Node.js release to
the next). With each change, Addons may need to be updated and recompiled in
order to continue functioning. The Node.js release schedule is designed to
minimize the frequency and impact of such changes but there is little that
Node.js can do currently to ensure stability of the V8 APIs.</p> <p>The <a href="https://github.com/nodejs/nan" target="_blank" rel="noopener noreferrer">Native Abstractions for Node.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> (or <code>nan</code>) provide a set of tools that
Addon developers are recommended to use to keep compatibility between past and
future releases of V8 and Node.js. See the <code>nan</code> <a href="https://github.com/nodejs/nan/tree/master/examples/" target="_blank" rel="noopener noreferrer">examples<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for an
illustration of how it can be used.</p> <h2 id="n-api"><a href="#n-api" class="header-anchor">#</a> N-API</h2> <blockquote><p>Stability: 2 - Stable</p></blockquote> <p>N-API is an API for building native Addons. It is independent from
the underlying JavaScript runtime (e.g. V8) and is maintained as part of
Node.js itself. This API will be Application Binary Interface (ABI) stable
across versions of Node.js. It is intended to insulate Addons from
changes in the underlying JavaScript engine and allow modules
compiled for one version to run on later versions of Node.js without
recompilation. Addons are built/packaged with the same approach/tools
outlined in this document (node-gyp, etc.). The only difference is the
set of APIs that are used by the native code. Instead of using the V8
or <a href="https://github.com/nodejs/nan" target="_blank" rel="noopener noreferrer">Native Abstractions for Node.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> APIs, the functions available
in the N-API are used.</p> <p>Creating and maintaining an addon that benefits from the ABI stability
provided by N-API carries with it certain
<a href="/public/blog/node/n-api.html#n_api_implications_of_abi_stability">implementation considerations</a>.</p> <p>To use N-API in the above &quot;Hello world&quot; example, replace the content of
<code>hello.cc</code> with the following. All other instructions remain the same.</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// hello.cc using N-API</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node_api.h&gt;</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

napi_value <span class="token function">Method</span><span class="token punctuation">(</span>napi_env env<span class="token punctuation">,</span> napi_callback_info args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  napi_value greeting<span class="token punctuation">;</span>
  napi_status status<span class="token punctuation">;</span>

  status <span class="token operator">=</span> <span class="token function">napi_create_string_utf8</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">&quot;world&quot;</span><span class="token punctuation">,</span> NAPI_AUTO_LENGTH<span class="token punctuation">,</span> <span class="token operator">&amp;</span>greeting<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> napi_ok<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> greeting<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

napi_value <span class="token function">init</span><span class="token punctuation">(</span>napi_env env<span class="token punctuation">,</span> napi_value exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  napi_status status<span class="token punctuation">;</span>
  napi_value fn<span class="token punctuation">;</span>

  status <span class="token operator">=</span> <span class="token function">napi_create_function</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Method<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> napi_ok<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

  status <span class="token operator">=</span> <span class="token function">napi_set_named_property</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> napi_ok<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> exports<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NAPI_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> init<span class="token punctuation">)</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace demo</span>
</code></pre></div><p>The functions available and how to use them are documented in
<a href="/public/blog/node/n-api.html">C/C++ Addons with N-API</a>.</p> <h2 id="addon-examples"><a href="#addon-examples" class="header-anchor">#</a> Addon examples</h2> <p>Following are some example Addons intended to help developers get started. The
examples make use of the V8 APIs. Refer to the online <a href="https://v8docs.nodesource.com/" target="_blank" rel="noopener noreferrer">V8 reference<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
for help with the various V8 calls, and V8's <a href="https://github.com/v8/v8/wiki/Embedder's%20Guide" target="_blank" rel="noopener noreferrer">Embedder's Guide<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for an
explanation of several concepts used such as handles, scopes, function
templates, etc.</p> <p>Each of these examples using the following <code>binding.gyp</code> file:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;targets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;target_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;addon&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;sources&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;addon.cc&quot;</span> <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In cases where there is more than one <code>.cc</code> file, simply add the additional
filename to the <code>sources</code> array:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;sources&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;addon.cc&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;myexample.cc&quot;</span><span class="token punctuation">]</span>
</code></pre></div><p>Once the <code>binding.gyp</code> file is ready, the example Addons can be configured and
built using <code>node-gyp</code>:</p> <div class="language-console extra-class"><pre class="language-text"><code>$ node-gyp configure build
</code></pre></div><h3 id="function-arguments"><a href="#function-arguments" class="header-anchor">#</a> Function arguments</h3> <p>Addons will typically expose objects and functions that can be accessed from
JavaScript running within Node.js. When functions are invoked from JavaScript,
the input arguments and return value must be mapped to and from the C/C++
code.</p> <p>The following example illustrates how to read function arguments passed from
JavaScript and how to return a result:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// addon.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h&gt;</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> v8<span class="token operator">::</span>Exception<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>NewStringType<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Number<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>String<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Value<span class="token punctuation">;</span>

<span class="token comment">// This is the implementation of the &quot;add&quot; method</span>
<span class="token comment">// Input arguments are passed using the</span>
<span class="token comment">// const FunctionCallbackInfo&lt;Value&gt;&amp; args struct</span>
<span class="token keyword">void</span> <span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Check the number of arguments passed.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">Length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Throw an Error that is passed back to JavaScript</span>
    isolate<span class="token operator">-&gt;</span><span class="token function">ThrowException</span><span class="token punctuation">(</span>Exception<span class="token operator">::</span><span class="token function">TypeError</span><span class="token punctuation">(</span>
        String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span>
                            <span class="token string">&quot;Wrong number of arguments&quot;</span><span class="token punctuation">,</span>
                            NewStringType<span class="token operator">::</span>kNormal<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Check the argument types</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">IsNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">IsNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    isolate<span class="token operator">-&gt;</span><span class="token function">ThrowException</span><span class="token punctuation">(</span>Exception<span class="token operator">::</span><span class="token function">TypeError</span><span class="token punctuation">(</span>
        String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span>
                            <span class="token string">&quot;Wrong arguments&quot;</span><span class="token punctuation">,</span>
                            NewStringType<span class="token operator">::</span>kNormal<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Perform the operation</span>
  <span class="token keyword">double</span> value <span class="token operator">=</span>
      args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>As<span class="token operator">&lt;</span>Number<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>As<span class="token operator">&lt;</span>Number<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Number<span class="token operator">&gt;</span> num <span class="token operator">=</span> Number<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Set the return value (using the passed in</span>
  <span class="token comment">// FunctionCallbackInfo&lt;Value&gt;&amp;)</span>
  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">NODE_SET_METHOD</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">&quot;add&quot;</span><span class="token punctuation">,</span> Add<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> Init<span class="token punctuation">)</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace demo</span>
</code></pre></div><p>Once compiled, the example Addon can be required and used from within Node.js:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// test.js</span>
<span class="token keyword">const</span> addon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'This should be eight:'</span><span class="token punctuation">,</span> addon<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="callbacks"><a href="#callbacks" class="header-anchor">#</a> Callbacks</h3> <p>It is common practice within Addons to pass JavaScript functions to a C++
function and execute them from there. The following example illustrates how
to invoke such callbacks:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// addon.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h&gt;</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> v8<span class="token operator">::</span>Context<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Function<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>NewStringType<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Null<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>String<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Value<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">RunCallback</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Context<span class="token operator">&gt;</span> context <span class="token operator">=</span> isolate<span class="token operator">-&gt;</span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span> cb <span class="token operator">=</span> Local<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">Cast</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">unsigned</span> argc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span>
                          <span class="token string">&quot;hello world&quot;</span><span class="token punctuation">,</span>
                          NewStringType<span class="token operator">::</span>kNormal<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  cb<span class="token operator">-&gt;</span><span class="token function">Call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token function">Null</span><span class="token punctuation">(</span>isolate<span class="token punctuation">)</span><span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">,</span> Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">NODE_SET_METHOD</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token string">&quot;exports&quot;</span><span class="token punctuation">,</span> RunCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> Init<span class="token punctuation">)</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace demo</span>
</code></pre></div><p>This example uses a two-argument form of <code>Init()</code> that receives the full
<code>module</code> object as the second argument. This allows the Addon to completely
overwrite <code>exports</code> with a single function instead of adding the function as a
property of <code>exports</code>.</p> <p>To test it, run the following JavaScript:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// test.js</span>
<span class="token keyword">const</span> addon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">addon</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Prints: 'hello world'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>In this example, the callback function is invoked synchronously.</p> <h3 id="object-factory"><a href="#object-factory" class="header-anchor">#</a> Object factory</h3> <p>Addons can create and return new objects from within a C++ function as
illustrated in the following example. An object is created and returned with a
property <code>msg</code> that echoes the string passed to <code>createObject()</code>:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// addon.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h&gt;</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> v8<span class="token operator">::</span>Context<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>NewStringType<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>String<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Value<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">CreateObject</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Context<span class="token operator">&gt;</span> context <span class="token operator">=</span> isolate<span class="token operator">-&gt;</span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> obj <span class="token operator">=</span> Object<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  obj<span class="token operator">-&gt;</span><span class="token function">Set</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>
           String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span>
                               <span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span>
                               NewStringType<span class="token operator">::</span>kNormal<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">ToString</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">FromJust</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">,</span> Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">NODE_SET_METHOD</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token string">&quot;exports&quot;</span><span class="token punctuation">,</span> CreateObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> Init<span class="token punctuation">)</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace demo</span>
</code></pre></div><p>To test it in JavaScript:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// test.js</span>
<span class="token keyword">const</span> addon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> obj1 <span class="token operator">=</span> <span class="token function">addon</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> obj2 <span class="token operator">=</span> <span class="token function">addon</span><span class="token punctuation">(</span><span class="token string">'world'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj1<span class="token punctuation">.</span>msg<span class="token punctuation">,</span> obj2<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Prints: 'hello world'</span>
</code></pre></div><h3 id="function-factory"><a href="#function-factory" class="header-anchor">#</a> Function factory</h3> <p>Another common scenario is creating JavaScript functions that wrap C++
functions and returning those back to JavaScript:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// addon.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h&gt;</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> v8<span class="token operator">::</span>Context<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Function<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionTemplate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>NewStringType<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>String<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Value<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">MyFunction</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>
      isolate<span class="token punctuation">,</span> <span class="token string">&quot;hello world&quot;</span><span class="token punctuation">,</span> NewStringType<span class="token operator">::</span>kNormal<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">CreateFunction</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  Local<span class="token operator">&lt;</span>Context<span class="token operator">&gt;</span> context <span class="token operator">=</span> isolate<span class="token operator">-&gt;</span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>FunctionTemplate<span class="token operator">&gt;</span> tpl <span class="token operator">=</span> FunctionTemplate<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> MyFunction<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span> fn <span class="token operator">=</span> tpl<span class="token operator">-&gt;</span><span class="token function">GetFunction</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// omit this to make it anonymous</span>
  fn<span class="token operator">-&gt;</span><span class="token function">SetName</span><span class="token punctuation">(</span>String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>
      isolate<span class="token punctuation">,</span> <span class="token string">&quot;theFunction&quot;</span><span class="token punctuation">,</span> NewStringType<span class="token operator">::</span>kNormal<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">,</span> Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">NODE_SET_METHOD</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token string">&quot;exports&quot;</span><span class="token punctuation">,</span> CreateFunction<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> Init<span class="token punctuation">)</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace demo</span>
</code></pre></div><p>To test:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// test.js</span>
<span class="token keyword">const</span> addon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">addon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Prints: 'hello world'</span>
</code></pre></div><h3 id="wrapping-c-objects"><a href="#wrapping-c-objects" class="header-anchor">#</a> Wrapping C++ objects</h3> <p>It is also possible to wrap C++ objects/classes in a way that allows new
instances to be created using the JavaScript <code>new</code> operator:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// addon.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;myobject.h&quot;</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">InitAll</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  MyObject<span class="token operator">::</span><span class="token function">Init</span><span class="token punctuation">(</span>exports<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> InitAll<span class="token punctuation">)</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace demo</span>
</code></pre></div><p>Then, in <code>myobject.h</code>, the wrapper class inherits from <code>node::ObjectWrap</code>:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// myobject.h</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> MYOBJECT_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MYOBJECT_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node_object_wrap.h&gt;</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">class</span> <span class="token class-name">MyObject</span> <span class="token operator">:</span> <span class="token keyword">public</span> node<span class="token operator">::</span>ObjectWrap <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span>v8<span class="token operator">::</span>Local<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">explicit</span> <span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token keyword">double</span> value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">~</span><span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token keyword">const</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">PlusOne</span><span class="token punctuation">(</span><span class="token keyword">const</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> v8<span class="token operator">::</span>Persistent<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Function<span class="token operator">&gt;</span> constructor<span class="token punctuation">;</span>
  <span class="token keyword">double</span> value_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace demo</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre></div><p>In <code>myobject.cc</code>, implement the various methods that are to be exposed.
Below, the method <code>plusOne()</code> is exposed by adding it to the constructor's
prototype:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// myobject.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;myobject.h&quot;</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> v8<span class="token operator">::</span>Context<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Function<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionTemplate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>NewStringType<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Number<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Persistent<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>String<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Value<span class="token punctuation">;</span>

Persistent<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span> MyObject<span class="token operator">::</span>constructor<span class="token punctuation">;</span>

MyObject<span class="token operator">::</span><span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token keyword">double</span> value<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">value_</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

MyObject<span class="token operator">::</span><span class="token operator">~</span><span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyObject<span class="token operator">::</span><span class="token function">Init</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> exports<span class="token operator">-&gt;</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Prepare constructor template</span>
  Local<span class="token operator">&lt;</span>FunctionTemplate<span class="token operator">&gt;</span> tpl <span class="token operator">=</span> FunctionTemplate<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> New<span class="token punctuation">)</span><span class="token punctuation">;</span>
  tpl<span class="token operator">-&gt;</span><span class="token function">SetClassName</span><span class="token punctuation">(</span>String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>
      isolate<span class="token punctuation">,</span> <span class="token string">&quot;MyObject&quot;</span><span class="token punctuation">,</span> NewStringType<span class="token operator">::</span>kNormal<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tpl<span class="token operator">-&gt;</span><span class="token function">InstanceTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">SetInternalFieldCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Prototype</span>
  <span class="token function">NODE_SET_PROTOTYPE_METHOD</span><span class="token punctuation">(</span>tpl<span class="token punctuation">,</span> <span class="token string">&quot;plusOne&quot;</span><span class="token punctuation">,</span> PlusOne<span class="token punctuation">)</span><span class="token punctuation">;</span>

  Local<span class="token operator">&lt;</span>Context<span class="token operator">&gt;</span> context <span class="token operator">=</span> isolate<span class="token operator">-&gt;</span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  constructor<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> tpl<span class="token operator">-&gt;</span><span class="token function">GetFunction</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  exports<span class="token operator">-&gt;</span><span class="token function">Set</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>
      isolate<span class="token punctuation">,</span> <span class="token string">&quot;MyObject&quot;</span><span class="token punctuation">,</span> NewStringType<span class="token operator">::</span>kNormal<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               tpl<span class="token operator">-&gt;</span><span class="token function">GetFunction</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FromJust</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyObject<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Context<span class="token operator">&gt;</span> context <span class="token operator">=</span> isolate<span class="token operator">-&gt;</span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">IsConstructCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Invoked as constructor: `new MyObject(...)`</span>
    <span class="token keyword">double</span> value <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">IsUndefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span>
        <span class="token number">0</span> <span class="token operator">:</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">NumberValue</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FromMaybe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MyObject<span class="token operator">*</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MyObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    obj<span class="token operator">-&gt;</span><span class="token function">Wrap</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">This</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">This</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Invoked as plain function `MyObject(...)`, turn into construct call.</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> argc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span> cons <span class="token operator">=</span> Local<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> result <span class="token operator">=</span>
        cons<span class="token operator">-&gt;</span><span class="token function">NewInstance</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyObject<span class="token operator">::</span><span class="token function">PlusOne</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  MyObject<span class="token operator">*</span> obj <span class="token operator">=</span> ObjectWrap<span class="token operator">::</span>Unwrap<span class="token operator">&lt;</span>MyObject<span class="token operator">&gt;</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">Holder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  obj<span class="token operator">-&gt;</span>value_ <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>Number<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> obj<span class="token operator">-&gt;</span>value_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace demo</span>
</code></pre></div><p>To build this example, the <code>myobject.cc</code> file must be added to the
<code>binding.gyp</code>:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;targets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;target_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;addon&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;sources&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;addon.cc&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;myobject.cc&quot;</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Test it with:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// test.js</span>
<span class="token keyword">const</span> addon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">addon<span class="token punctuation">.</span>MyObject</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">plusOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Prints: 11</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">plusOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Prints: 12</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">plusOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Prints: 13</span>
</code></pre></div><p>The destructor for a wrapper object will run when the object is
garbage-collected. For destructor testing, there are command-line flags that
can be used to make it possible to force garbage collection. These flags are
provided by the underlying V8 JavaScript engine. They are subject to change
or removal at any time. They are not documented by Node.js or V8, and they
should never be used outside of testing.</p> <h3 id="factory-of-wrapped-objects"><a href="#factory-of-wrapped-objects" class="header-anchor">#</a> Factory of wrapped objects</h3> <p>Alternatively, it is possible to use a factory pattern to avoid explicitly
creating object instances using the JavaScript <code>new</code> operator:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> addon<span class="token punctuation">.</span><span class="token function">createObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// instead of:</span>
<span class="token comment">// const obj = new addon.Object();</span>
</code></pre></div><p>First, the <code>createObject()</code> method is implemented in <code>addon.cc</code>:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// addon.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;myobject.h&quot;</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>String<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Value<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">CreateObject</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  MyObject<span class="token operator">::</span><span class="token function">NewInstance</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">InitAll</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">,</span> Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  MyObject<span class="token operator">::</span><span class="token function">Init</span><span class="token punctuation">(</span>exports<span class="token operator">-&gt;</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">NODE_SET_METHOD</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token string">&quot;exports&quot;</span><span class="token punctuation">,</span> CreateObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> InitAll<span class="token punctuation">)</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace demo</span>
</code></pre></div><p>In <code>myobject.h</code>, the static method <code>NewInstance()</code> is added to handle
instantiating the object. This method takes the place of using <code>new</code> in
JavaScript:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// myobject.h</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> MYOBJECT_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MYOBJECT_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node_object_wrap.h&gt;</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">class</span> <span class="token class-name">MyObject</span> <span class="token operator">:</span> <span class="token keyword">public</span> node<span class="token operator">::</span>ObjectWrap <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span>v8<span class="token operator">::</span>Isolate<span class="token operator">*</span> isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">NewInstance</span><span class="token punctuation">(</span><span class="token keyword">const</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">explicit</span> <span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token keyword">double</span> value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">~</span><span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token keyword">const</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">PlusOne</span><span class="token punctuation">(</span><span class="token keyword">const</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> v8<span class="token operator">::</span>Persistent<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Function<span class="token operator">&gt;</span> constructor<span class="token punctuation">;</span>
  <span class="token keyword">double</span> value_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace demo</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre></div><p>The implementation in <code>myobject.cc</code> is similar to the previous example:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// myobject.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;myobject.h&quot;</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> v8<span class="token operator">::</span>Context<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Function<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionTemplate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>NewStringType<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Number<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Persistent<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>String<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Value<span class="token punctuation">;</span>

Persistent<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span> MyObject<span class="token operator">::</span>constructor<span class="token punctuation">;</span>

MyObject<span class="token operator">::</span><span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token keyword">double</span> value<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">value_</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

MyObject<span class="token operator">::</span><span class="token operator">~</span><span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyObject<span class="token operator">::</span><span class="token function">Init</span><span class="token punctuation">(</span>Isolate<span class="token operator">*</span> isolate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Prepare constructor template</span>
  Local<span class="token operator">&lt;</span>FunctionTemplate<span class="token operator">&gt;</span> tpl <span class="token operator">=</span> FunctionTemplate<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> New<span class="token punctuation">)</span><span class="token punctuation">;</span>
  tpl<span class="token operator">-&gt;</span><span class="token function">SetClassName</span><span class="token punctuation">(</span>String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>
      isolate<span class="token punctuation">,</span> <span class="token string">&quot;MyObject&quot;</span><span class="token punctuation">,</span> NewStringType<span class="token operator">::</span>kNormal<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tpl<span class="token operator">-&gt;</span><span class="token function">InstanceTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">SetInternalFieldCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Prototype</span>
  <span class="token function">NODE_SET_PROTOTYPE_METHOD</span><span class="token punctuation">(</span>tpl<span class="token punctuation">,</span> <span class="token string">&quot;plusOne&quot;</span><span class="token punctuation">,</span> PlusOne<span class="token punctuation">)</span><span class="token punctuation">;</span>

  Local<span class="token operator">&lt;</span>Context<span class="token operator">&gt;</span> context <span class="token operator">=</span> isolate<span class="token operator">-&gt;</span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  constructor<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> tpl<span class="token operator">-&gt;</span><span class="token function">GetFunction</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyObject<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Context<span class="token operator">&gt;</span> context <span class="token operator">=</span> isolate<span class="token operator">-&gt;</span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">IsConstructCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Invoked as constructor: `new MyObject(...)`</span>
    <span class="token keyword">double</span> value <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">IsUndefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span>
        <span class="token number">0</span> <span class="token operator">:</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">NumberValue</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FromMaybe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MyObject<span class="token operator">*</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MyObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    obj<span class="token operator">-&gt;</span><span class="token function">Wrap</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">This</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">This</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Invoked as plain function `MyObject(...)`, turn into construct call.</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> argc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span> cons <span class="token operator">=</span> Local<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> instance <span class="token operator">=</span>
        cons<span class="token operator">-&gt;</span><span class="token function">NewInstance</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyObject<span class="token operator">::</span><span class="token function">NewInstance</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token keyword">unsigned</span> argc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span> cons <span class="token operator">=</span> Local<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Context<span class="token operator">&gt;</span> context <span class="token operator">=</span> isolate<span class="token operator">-&gt;</span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> instance <span class="token operator">=</span>
      cons<span class="token operator">-&gt;</span><span class="token function">NewInstance</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyObject<span class="token operator">::</span><span class="token function">PlusOne</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  MyObject<span class="token operator">*</span> obj <span class="token operator">=</span> ObjectWrap<span class="token operator">::</span>Unwrap<span class="token operator">&lt;</span>MyObject<span class="token operator">&gt;</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">Holder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  obj<span class="token operator">-&gt;</span>value_ <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>Number<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> obj<span class="token operator">-&gt;</span>value_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace demo</span>
</code></pre></div><p>Once again, to build this example, the <code>myobject.cc</code> file must be added to the
<code>binding.gyp</code>:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;targets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;target_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;addon&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;sources&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;addon.cc&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;myobject.cc&quot;</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Test it with:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// test.js</span>
<span class="token keyword">const</span> createObject <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">plusOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Prints: 11</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">plusOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Prints: 12</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">plusOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Prints: 13</span>

<span class="token keyword">const</span> obj2 <span class="token operator">=</span> <span class="token function">createObject</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">.</span><span class="token function">plusOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Prints: 21</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">.</span><span class="token function">plusOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Prints: 22</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj2<span class="token punctuation">.</span><span class="token function">plusOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Prints: 23</span>
</code></pre></div><h3 id="passing-wrapped-objects-around"><a href="#passing-wrapped-objects-around" class="header-anchor">#</a> Passing wrapped objects around</h3> <p>In addition to wrapping and returning C++ objects, it is possible to pass
wrapped objects around by unwrapping them with the Node.js helper function
<code>node::ObjectWrap::Unwrap</code>. The following examples shows a function <code>add()</code>
that can take two <code>MyObject</code> objects as input arguments:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// addon.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node_object_wrap.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;myobject.h&quot;</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> v8<span class="token operator">::</span>Context<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Number<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>String<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Value<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">CreateObject</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  MyObject<span class="token operator">::</span><span class="token function">NewInstance</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Context<span class="token operator">&gt;</span> context <span class="token operator">=</span> isolate<span class="token operator">-&gt;</span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  MyObject<span class="token operator">*</span> obj1 <span class="token operator">=</span> node<span class="token operator">::</span>ObjectWrap<span class="token operator">::</span>Unwrap<span class="token operator">&lt;</span>MyObject<span class="token operator">&gt;</span><span class="token punctuation">(</span>
      args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">ToObject</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  MyObject<span class="token operator">*</span> obj2 <span class="token operator">=</span> node<span class="token operator">::</span>ObjectWrap<span class="token operator">::</span>Unwrap<span class="token operator">&lt;</span>MyObject<span class="token operator">&gt;</span><span class="token punctuation">(</span>
      args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">ToObject</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">double</span> sum <span class="token operator">=</span> obj1<span class="token operator">-&gt;</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> obj2<span class="token operator">-&gt;</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>Number<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> sum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">InitAll</span><span class="token punctuation">(</span>Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  MyObject<span class="token operator">::</span><span class="token function">Init</span><span class="token punctuation">(</span>exports<span class="token operator">-&gt;</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">NODE_SET_METHOD</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">&quot;createObject&quot;</span><span class="token punctuation">,</span> CreateObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">NODE_SET_METHOD</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">&quot;add&quot;</span><span class="token punctuation">,</span> Add<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> InitAll<span class="token punctuation">)</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace demo</span>
</code></pre></div><p>In <code>myobject.h</code>, a new public method is added to allow access to private values
after unwrapping the object.</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// myobject.h</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> MYOBJECT_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MYOBJECT_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node_object_wrap.h&gt;</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">class</span> <span class="token class-name">MyObject</span> <span class="token operator">:</span> <span class="token keyword">public</span> node<span class="token operator">::</span>ObjectWrap <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span>v8<span class="token operator">::</span>Isolate<span class="token operator">*</span> isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">NewInstance</span><span class="token punctuation">(</span><span class="token keyword">const</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">inline</span> <span class="token keyword">double</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> value_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">explicit</span> <span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token keyword">double</span> value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">~</span><span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token keyword">const</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> v8<span class="token operator">::</span>Persistent<span class="token operator">&lt;</span>v8<span class="token operator">::</span>Function<span class="token operator">&gt;</span> constructor<span class="token punctuation">;</span>
  <span class="token keyword">double</span> value_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace demo</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre></div><p>The implementation of <code>myobject.cc</code> is similar to before:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// myobject.cc</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;node.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;myobject.h&quot;</span></span>

<span class="token keyword">namespace</span> demo <span class="token punctuation">{</span>

<span class="token keyword">using</span> v8<span class="token operator">::</span>Context<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Function<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionCallbackInfo<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>FunctionTemplate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Isolate<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Local<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>NewStringType<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Object<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Persistent<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>String<span class="token punctuation">;</span>
<span class="token keyword">using</span> v8<span class="token operator">::</span>Value<span class="token punctuation">;</span>

Persistent<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span> MyObject<span class="token operator">::</span>constructor<span class="token punctuation">;</span>

MyObject<span class="token operator">::</span><span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token keyword">double</span> value<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">value_</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

MyObject<span class="token operator">::</span><span class="token operator">~</span><span class="token function">MyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyObject<span class="token operator">::</span><span class="token function">Init</span><span class="token punctuation">(</span>Isolate<span class="token operator">*</span> isolate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Prepare constructor template</span>
  Local<span class="token operator">&lt;</span>FunctionTemplate<span class="token operator">&gt;</span> tpl <span class="token operator">=</span> FunctionTemplate<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> New<span class="token punctuation">)</span><span class="token punctuation">;</span>
  tpl<span class="token operator">-&gt;</span><span class="token function">SetClassName</span><span class="token punctuation">(</span>String<span class="token operator">::</span><span class="token function">NewFromUtf8</span><span class="token punctuation">(</span>
      isolate<span class="token punctuation">,</span> <span class="token string">&quot;MyObject&quot;</span><span class="token punctuation">,</span> NewStringType<span class="token operator">::</span>kNormal<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tpl<span class="token operator">-&gt;</span><span class="token function">InstanceTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">SetInternalFieldCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  Local<span class="token operator">&lt;</span>Context<span class="token operator">&gt;</span> context <span class="token operator">=</span> isolate<span class="token operator">-&gt;</span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  constructor<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> tpl<span class="token operator">-&gt;</span><span class="token function">GetFunction</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyObject<span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Context<span class="token operator">&gt;</span> context <span class="token operator">=</span> isolate<span class="token operator">-&gt;</span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">IsConstructCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Invoked as constructor: `new MyObject(...)`</span>
    <span class="token keyword">double</span> value <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">IsUndefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span>
        <span class="token number">0</span> <span class="token operator">:</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">NumberValue</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FromMaybe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MyObject<span class="token operator">*</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MyObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    obj<span class="token operator">-&gt;</span><span class="token function">Wrap</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">This</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">This</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Invoked as plain function `MyObject(...)`, turn into construct call.</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> argc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span> cons <span class="token operator">=</span> Local<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> instance <span class="token operator">=</span>
        cons<span class="token operator">-&gt;</span><span class="token function">NewInstance</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyObject<span class="token operator">::</span><span class="token function">NewInstance</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionCallbackInfo<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Isolate<span class="token operator">*</span> isolate <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">GetIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token keyword">unsigned</span> argc <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Value<span class="token operator">&gt;</span> argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span> cons <span class="token operator">=</span> Local<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">New</span><span class="token punctuation">(</span>isolate<span class="token punctuation">,</span> constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Context<span class="token operator">&gt;</span> context <span class="token operator">=</span> isolate<span class="token operator">-&gt;</span><span class="token function">GetCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Local<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> instance <span class="token operator">=</span>
      cons<span class="token operator">-&gt;</span><span class="token function">NewInstance</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLocalChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  args<span class="token punctuation">.</span><span class="token function">GetReturnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span>  <span class="token comment">// namespace demo</span>
</code></pre></div><p>Test it with:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// test.js</span>
<span class="token keyword">const</span> addon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build/Release/addon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> obj1 <span class="token operator">=</span> addon<span class="token punctuation">.</span><span class="token function">createObject</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> obj2 <span class="token operator">=</span> addon<span class="token punctuation">.</span><span class="token function">createObject</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> addon<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj1<span class="token punctuation">,</span> obj2<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Prints: 30</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/public/blog/assets/js/app.793d18d6.js" defer></script><script src="/public/blog/assets/js/2.d1dd4e4d.js" defer></script><script src="/public/blog/assets/js/10.7d4b1d4b.js" defer></script><script src="/public/blog/assets/js/3.1f730cd9.js" defer></script>
  </body>
</html>
